<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Animal Habitat Map - {{ habitat_data.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header>
    <h1>üêæ Animal Identifier</h1>
    <p>Interactive habitat mapping powered by AI</p>
  </header>
  
  <main class="container">
    
    <!-- Species Hero Section -->
    <section class="species-hero">
      <div class="hero-content">
        <div class="hero-icon">üó∫Ô∏è</div>
        <div class="hero-text">
          <h2 class="hero-title">{{ habitat_data.name }}</h2>
          <p class="hero-subtitle">{{ habitat_data.description }}</p>
        </div>
      </div>
      
      <div class="stats-indicator">
        <div class="stats-badge">
          <span class="stats-icon">üìç</span>
          <span class="stats-text">{{ habitat_data.habitats|length }} Habitat Locations</span>
        </div>
      </div>
    </section>

    <!-- Map Section -->
    <section class="map-section">
      <div class="map-header">
        <div class="map-title">
          <h3>üåç Global Habitat Distribution</h3>
          <p>Explore the natural habitats where this species can be found</p>
        </div>
      </div>
      
      <div class="map-container">
        <div id="map"></div>
        
        <!-- Map Controls - Inside map -->
        <div class="map-controls">
          <button class="control-btn primary" onclick="fitToMarkers()">
            <span class="btn-icon">üéØ</span>
            <span class="btn-text">Show All</span>
          </button>
          <button class="control-btn secondary" onclick="toggleMarkers()">
            <span class="btn-icon">üëÅÔ∏è</span>
            <span class="btn-text">Toggle</span>
          </button>
          <button class="control-btn tertiary" onclick="resetView()">
            <span class="btn-icon">üîÑ</span>
            <span class="btn-text">Reset</span>
          </button>
        </div>
        
        <!-- Map Legend - Better positioned -->
        <div class="map-legend">
          <div class="legend-header">
            <span class="legend-icon">üé®</span>
            <span class="legend-title">Habitat Types</span>
          </div>
          <div class="legend-items">
            <div class="legend-item">
              <div class="legend-color tropical"></div>
              <span class="legend-label">Tropical</span>
            </div>
            <div class="legend-item">
              <div class="legend-color temperate"></div>
              <span class="legend-label">Temperate</span>
            </div>
            <div class="legend-item">
              <div class="legend-color polar"></div>
              <span class="legend-label">Polar</span>
            </div>
            <div class="legend-item">
              <div class="legend-color subtropical"></div>
              <span class="legend-label">Subtropical</span>
            </div>
            <div class="legend-item">
              <div class="legend-color savanna"></div>
              <span class="legend-label">Savanna</span>
            </div>
            <div class="legend-item">
              <div class="legend-color forest"></div>
              <span class="legend-label">Forest</span>
            </div>
          </div>
        </div>
      </div>
      
    </section>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href="/" class="action-btn primary">
        <span class="btn-icon">üîç</span>
        <span class="btn-text">Identify Another Animal</span>
      </a>
      <button class="action-btn secondary" onclick="downloadMap()">
        <span class="btn-icon">üì•</span>
        <span class="btn-text">Download Map</span>
      </button>
    </div>

  </main>
  
  <footer>Interactive Habitat Mapping ‚Ä¢ Powered by Leaflet ‚Ä¢ AI-driven species analysis</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let markers = [];
    let markersVisible = true;
    
    const habitatData = {{ habitat_data | tojson }};
    
    // Debug: Check if coordinates are being converted to strings
    console.log('=== HABITAT DATA ANALYSIS ===');
    console.log('Full habitat data:', habitatData);
    if (habitatData.habitats && habitatData.habitats.length > 0) {
      const firstHabitat = habitatData.habitats[0];
      console.log('First habitat lat type:', typeof firstHabitat.lat, 'value:', firstHabitat.lat);
      console.log('First habitat lng type:', typeof firstHabitat.lng, 'value:', firstHabitat.lng);
      console.log('Is lat a string?', typeof firstHabitat.lat === 'string');
      console.log('Is lng a string?', typeof firstHabitat.lng === 'string');
    }
    
    // FIX: Ensure all coordinates are numbers, not strings
    if (habitatData.habitats) {
      habitatData.habitats.forEach(habitat => {
        if (typeof habitat.lat === 'string') {
          habitat.lat = parseFloat(habitat.lat);
        }
        if (typeof habitat.lng === 'string') {
          habitat.lng = parseFloat(habitat.lng);
        }
      });
      console.log('‚úÖ Coordinates converted to numbers');
    }
    
    function getHabitatColor(type) {
      const colors = {
        'tropical': '#ff6b6b',
        'temperate': '#4ecdc4',
        'polar': '#45b7d1',
        'arctic': '#45b7d1',
        'subtropical': '#96ceb4',
        'savanna': '#feca57',
        'forest': '#2ecc71',
        'mountain': '#8e44ad',
        'boreal': '#27ae60',
        'mediterranean': '#f39c12',
        'arid': '#e67e22',
        'unknown': '#ffffff'
      };
      return colors[type] || '#ffffff';
    }
    
    function initMap() {
      // Initialize the map
      map = L.map('map', {
        center: [20, 0],
        zoom: 2,
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true,
        dragging: true,
        touchZoom: true
      });
      
      // Add tile layer (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);
      
      // Add habitat markers
      addHabitatMarkers();
      
      // Initialize button text
      updateToggleButtonText();
      
      // Fit map to show all markers
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    function addHabitatMarkers() {
      console.log('=== STARTING MARKER CREATION ===');
      console.log('Full habitat data:', JSON.stringify(habitatData, null, 2));
      console.log('Number of habitats:', habitatData.habitats.length);
      
      // First, let's test with a known good coordinate to see if the map works
      console.log('Testing with known coordinate: New York (40.7128, -74.0060)');
      const testMarker = L.marker([40.7128, -74.0060]).addTo(map);
      testMarker.bindPopup('Test: New York - This should be in NYC');
      setTimeout(() => {
        map.removeLayer(testMarker);
        console.log('Test marker removed, proceeding with habitat markers...');
      }, 3000);
      
      // Clear any existing markers first
      markers.forEach(marker => {
        map.removeLayer(marker);
      });
      markers = [];
      
      habitatData.habitats.forEach((habitat, index) => {
        console.log(`\n--- Processing Habitat ${index + 1} ---`);
        console.log('Raw habitat data:', habitat);
        console.log('Raw lat type:', typeof habitat.lat, 'value:', habitat.lat);
        console.log('Raw lng type:', typeof habitat.lng, 'value:', habitat.lng);
        
        // Get coordinates (now guaranteed to be numbers from preprocessing)
        const lat = habitat.lat;
        const lng = habitat.lng;
        
        console.log(`Final coordinates: lat=${lat} (type: ${typeof lat}), lng=${lng} (type: ${typeof lng})`);
        
        // Validate coordinates
        if (isNaN(lat) || isNaN(lng)) {
          console.error(`‚ùå Invalid coordinates for ${habitat.name}: lat=${lat}, lng=${lng}`);
          return;
        }
        
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          console.error(`‚ùå Coordinates out of range for ${habitat.name}: lat=${lat}, lng=${lng}`);
          return;
        }
        
        console.log(`‚úÖ Valid coordinates: [${lat}, ${lng}]`);
        
        // CRITICAL FIX: Leaflet expects [LATITUDE, LONGITUDE] format
        // Our data might be in [LONGITUDE, LATITUDE] format
        // Let's test both formats to see which works
        
        // Try CORRECT format first: [lat, lng]
        console.log(`Testing CORRECT format: [${lat}, ${lng}]`);
        const correctCoords = [lat, lng];
        
        // Try WRONG format: [lng, lat] 
        console.log(`Testing WRONG format: [${lng}, ${lat}]`);
        const wrongCoords = [lng, lat];
        
        // Create a colored marker icon
        const color = getHabitatColor(habitat.type);
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="
            background: ${color};
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            display: block;
          "></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8],
          popupAnchor: [0, -8]
        });
        
        // Create marker with CORRECT format
        const marker = L.marker(correctCoords, {
          icon: markerIcon
        }).addTo(map);
        
        // Add popup
        marker.bindPopup(`
          <div style="font-family: Arial, sans-serif; padding: 8px;">
            <h4 style="margin: 0 0 8px 0; color: #333;">${habitat.name}</h4>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Type:</strong> ${habitat.type}</p>
            <p style="margin: 4px 0; font-size: 12px;"><strong>Coordinates:</strong> ${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞</p>
          </div>
        `);
        
        markers.push(marker);
        console.log(`‚úÖ Marker ${index + 1} created at [${lat}, ${lng}] for ${habitat.name}`);
      });
      
      console.log(`\n=== MARKER CREATION COMPLETE ===`);
      console.log(`Total markers created: ${markers.length}`);
      
      // Wait a bit then check marker positions
      setTimeout(() => {
        console.log('\n=== CHECKING MARKER POSITIONS ===');
        markers.forEach((marker, index) => {
          const pos = marker.getLatLng();
          console.log(`Marker ${index + 1}: ${pos.lat}, ${pos.lng}`);
        });
        
        // Fit map to show all markers
        if (markers.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
          console.log('Map fitted to show all markers');
        }
      }, 500);
    }
    
    function fitToMarkers() {
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    function updateToggleButtonText() {
      const toggleBtn = document.querySelector('.control-btn.secondary .btn-text');
      if (toggleBtn) {
        toggleBtn.textContent = markersVisible ? 'Hide Markers' : 'Show Markers';
      }
    }
    
    function toggleMarkers() {
      markersVisible = !markersVisible;
      markers.forEach(marker => {
        if (markersVisible) {
          map.addLayer(marker);
        } else {
          map.removeLayer(marker);
        }
      });
      
      updateToggleButtonText();
    }
    
    function resetView() {
      map.setView([20, 0], 2);
    }
    
    function flyToLocation(lat, lng, name) {
      map.flyTo([lat, lng], 8, {
        animate: true,
        duration: 1.5
      });
      
      // Find and open the popup for this marker
      markers.forEach(marker => {
        if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lng) {
          setTimeout(() => marker.openPopup(), 1000);
        }
      });
    }
    
    function downloadMap() {
      // Create a simple download function
      const mapData = {
        species: habitatData.name,
        habitats: habitatData.habitats.length,
        coordinates: habitatData.habitats.map(h => `${h.name}: ${h.lat}, ${h.lng}`).join('\n')
      };
      
      const content = `Habitat Map: ${mapData.species}\n\nTotal Habitats: ${mapData.habitats}\n\nCoordinates:\n${mapData.coordinates}`;
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `habitat-map-${habitatData.name.replace(/\s+/g, '-').toLowerCase()}.txt`;
      link.click();
      URL.revokeObjectURL(url);
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    });
    
    // Test function to add sample markers
    function addTestMarkers() {
      console.log('Adding test markers...');
      
      // Add some test markers with known coordinates
      const testLocations = [
        { name: 'New York', lat: 40.7128, lng: -74.0060 },
        { name: 'London', lat: 51.5074, lng: -0.1278 },
        { name: 'Tokyo', lat: 35.6762, lng: 139.6503 },
        { name: 'Sydney', lat: -33.8688, lng: 151.2093 }
      ];
      
      testLocations.forEach((location, index) => {
        // Create a simple blue test marker
        const testIcon = L.divIcon({
          className: 'test-marker',
          html: `<div style="
            background: #007bff; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 2px solid white; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            display: block;
          "></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8],
          popupAnchor: [0, -8]
        });
        
        const marker = L.marker([location.lat, location.lng], {
          icon: testIcon
        }).addTo(map);
        marker.bindPopup(`<b>${location.name}</b><br>Test marker ${index + 1}`);
        console.log(`Test marker ${index + 1} added at [${location.lat}, ${location.lng}]`);
      });
      
      // Fit map to show test markers
      const group = new L.featureGroup(map._layers);
      map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Initialize when page loads
    window.addEventListener('load', initMap);
  </script>
</body>
</html>