<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Animal Discovery - Results</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Header Navigation -->
  <nav class="header-nav">
    <div class="nav-container">
      <div class="logo">
        <span class="logo-icon">üçÉ</span>
        <span class="logo-text">WildID</span>
      </div>
      <div class="nav-links">
        <a href="/" class="nav-link">Home</a>
        <a href="/discovery" class="nav-link active">Discovery</a>
        {% if current_user %}
          <a href="/history" class="nav-link">History</a>
          <a href="/auth/logout" class="nav-link">Sign Out</a>
        {% else %}
          <a href="/auth/login" class="nav-link">Sign In</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="results-main">
    <div class="results-container">
      
      {% if result.is_animal %}
      <!-- Main Species Card -->
      <div class="species-main-card">
        <div class="species-header">
          <div class="species-title-section">
            <h2 class="species-name">
              {% if result.common_name and result.common_name != "Unknown" %}
                {{ result.common_name }}
              {% elif result.species and result.species != "Unknown" %}
                {{ result.species }}
              {% else %}
                Animal Species
              {% endif %}
            </h2>
            {% if result.species and result.species != "Unknown" %}
            <p class="species-scientific">{{ result.species }}</p>
            {% endif %}
          </div>
          <div class="conservation-status">
            {% if conservation_info %}
              {% set status = conservation_info.status %}
              {% if status == "Endangered" or status == "Critically Endangered" %}
                <span class="status-badge endangered">{{ status }}</span>
              {% elif status == "Vulnerable" %}
                <span class="status-badge vulnerable">{{ status }}</span>
              {% elif status == "Near Threatened" %}
                <span class="status-badge near-threatened">{{ status }}</span>
              {% elif status == "Least Concern" %}
                <span class="status-badge least-concern">{{ status }}</span>
              {% elif status == "Data Deficient" %}
                <span class="status-badge data-deficient">{{ status }}</span>
              {% else %}
                <span class="status-badge unknown">{{ status or "Unknown" }}</span>
              {% endif %}
            {% else %}
              <span class="status-badge unknown">{{ result.conservation_status or "Unknown" }}</span>
            {% endif %}
          </div>
        </div>

        <div class="species-content">
          <div class="species-image-section">
            <div class="species-image-container">
              <img class="species-image" src="data:{{ image_mime }};base64,{{ image_data }}" alt="Species image">
            </div>
          </div>

          <div class="species-info-section">
            <div class="info-item">
              <div class="info-label">
                <i class="fas fa-globe info-icon-inline"></i>
                Origin
              </div>
              <div class="info-value">
                {% if fun_facts_info and fun_facts_info.origin %}
                  {{ fun_facts_info.origin }}
                {% else %}
                  Native habitats vary by region for this species
                {% endif %}
              </div>
            </div>

            <div class="info-item">
              <div class="info-label">Description</div>
              <div class="info-value">
                {% if result.description %}
                  {{ result.description }}
                {% else %}
                  A fascinating species with unique characteristics and behaviors. This animal represents an important part of our natural world.
                {% endif %}
              </div>
            </div>
            
            {% if result.confidence and result.confidence.lower() in ['low', 'medium'] %}
            <div class="confidence-warning">
              <strong>‚ö†Ô∏è {{ result.confidence|capitalize }} Confidence Identification</strong>
              <p style="margin: 8px 0 0 0; font-size: 14px;">
                {% if result.confidence.lower() == 'low' %}
                The AI is uncertain about this identification. Consider trying again with a clearer photo (better lighting, closer view, different angle) or consult an expert.
                {% else %}
                The AI is moderately confident but not certain. Consider taking additional photos from different angles for verification.
                {% endif %}
              </p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Information Cards Grid -->
      <div class="info-cards-grid">
        
        <!-- Fun Fact Card -->
        <div class="info-card fun-fact-card">
          <div class="card-header">
            <i class="fas fa-lightbulb card-icon"></i>
            <h3 class="card-title">Fun Fact</h3>
          </div>
          <div class="card-content">
            <p>
              {% if fun_facts_info and fun_facts_info.fun_fact %}
                {{ fun_facts_info.fun_fact }}
              {% else %}
                This species has unique characteristics and behaviors that make it fascinating to study. Each animal plays an important role in its ecosystem.
              {% endif %}
            </p>
          </div>
        </div>

        <!-- Conservation Information Card -->
        <div class="info-card conservation-card">
          <div class="card-header">
            <i class="fas fa-exclamation-triangle card-icon"></i>
            <h3 class="card-title">Conservation Information</h3>
          </div>
          <div class="card-content">
            {% if conservation_info %}
            <div class="conservation-detail">
              <div class="detail-label">Population:</div>
              <div class="detail-value">{{ conservation_info.population }}</div>
            </div>
            <div class="conservation-detail">
              <div class="detail-label">Population Trend:</div>
              <div class="detail-value">{{ conservation_info.trend }}</div>
            </div>
            <div class="conservation-detail">
              <div class="detail-label">Main Threats:</div>
              <div class="detail-value">{{ conservation_info.threats }}</div>
            </div>
            <div class="conservation-detail">
              <div class="detail-label">How You Can Help:</div>
              <div class="detail-value">
                {% if help_tips %}
                  {{ help_tips }}
                {% else %}
                  Support wildlife conservation organizations, reduce your environmental impact, and educate others about the importance of protecting all species and their habitats.
                {% endif %}
              </div>
            </div>
            {% else %}
            <div class="conservation-detail">
              <div class="detail-label">Status:</div>
              <div class="detail-value">{{ result.conservation_status or "Unknown" }}</div>
            </div>
            <div class="conservation-detail">
              <div class="detail-label">Note:</div>
              <div class="detail-value">Detailed conservation information is not available for this species. Consider supporting general wildlife conservation efforts.</div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Natural Habitat Card -->
        <div class="info-card habitat-card">
          <div class="card-header">
            <i class="fas fa-map-marker-alt card-icon"></i>
            <h3 class="card-title">Natural Habitat</h3>
          </div>
          <div class="card-content">
            <div class="habitat-detail">
              <div class="detail-label">Region:</div>
              <div class="detail-value">Global tropical and subtropical waters</div>
            </div>
            <div class="habitat-detail">
              <div class="detail-label">Countries:</div>
              <div class="country-tags">
                <span class="country-tag">Australia</span>
                <span class="country-tag">Costa Rica</span>
                <span class="country-tag">Hawaii</span>
                <span class="country-tag">Mexico</span>
                <span class="country-tag">Indonesia</span>
              </div>
            </div>
            <div class="habitat-detail">
              <div class="detail-label">Interactive Map:</div>
              <div class="embedded-map-container">
                <div id="embedded-map"></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Accuracy Feedback (for logged in users) -->
      {% if current_user and identification_id %}
      <div class="feedback-section" id="feedback-section">
        <h3 style="text-align: center; color: #2c3e50; margin-bottom: 16px;">Was this identification correct?</h3>
        <div class="feedback-buttons" style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px;">
          <button onclick="submitFeedback('correct')" class="feedback-btn correct-btn" id="correct-btn">
            <i class="fas fa-check-circle"></i> Yes, Correct
          </button>
          <button onclick="submitFeedback('incorrect')" class="feedback-btn incorrect-btn" id="incorrect-btn">
            <i class="fas fa-times-circle"></i> No, Incorrect
          </button>
        </div>
        <div id="feedback-message" style="text-align: center; display: none; padding: 12px; border-radius: 8px; margin-top: 12px;"></div>
      </div>
      {% endif %}

      <!-- Action Buttons -->
      <div class="action-buttons">
        <a href="/discovery" class="action-btn primary-btn">
          <i class="fas fa-redo"></i>
          <span>Try Again / Identify Another</span>
        </a>
        {% if current_user %}
        <a href="/history" class="action-btn secondary-btn" style="background: #757575;">
          <i class="fas fa-history"></i>
          <span>View History</span>
        </a>
        {% endif %}
      </div>

      {% else %}
      <!-- No Animal Detected -->
      <div class="no-animal-card">
        <div class="no-animal-content">
          <div class="no-animal-icon">
            <i class="fas fa-question-circle"></i>
          </div>
          <h2 class="no-animal-title">No Animal Detected</h2>
          <p class="no-animal-description">The AI analysis indicates this image does not contain an identifiable animal. Please try uploading a different image.</p>
          <a href="/discovery" class="action-btn primary-btn">
            <i class="fas fa-upload"></i>
            <span>Try Another Image</span>
          </a>
        </div>
      </div>
      {% endif %}

    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>WildID ‚Ä¢ Wildlife Identification ‚Ä¢ Auto file cleanup ‚Ä¢ Interactive habitat mapping</p>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    .feedback-section {
      max-width: 800px;
      margin: 30px auto;
      padding: 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .feedback-btn {
      padding: 12px 24px;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .feedback-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .feedback-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .correct-btn {
      background: #4CAF50;
      color: white;
    }
    
    .correct-btn:hover:not(:disabled) {
      background: #45a049;
    }
    
    .incorrect-btn {
      background: #f44336;
      color: white;
    }
    
    .incorrect-btn:hover:not(:disabled) {
      background: #da190b;
    }
    
    .feedback-message-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .feedback-message-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .secondary-btn {
      background: #757575;
      color: white;
      border: none;
    }
    
    .secondary-btn:hover {
      background: #616161;
    }
    
    .confidence-warning {
      margin-top: 16px;
      padding: 16px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      text-align: center;
    }
    
    .confidence-warning strong {
      color: #856404;
    }
  </style>
  
  <script>
    // Store identification ID for feedback
    const identificationId = {{ identification_id|tojson }};
    
    // Submit feedback
    async function submitFeedback(feedback) {
      if (!identificationId) {
        alert('Unable to submit feedback. Please sign in and try again.');
        return;
      }
      
      const correctBtn = document.getElementById('correct-btn');
      const incorrectBtn = document.getElementById('incorrect-btn');
      const messageDiv = document.getElementById('feedback-message');
      
      // Disable buttons
      correctBtn.disabled = true;
      incorrectBtn.disabled = true;
      
      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            identification_id: identificationId,
            feedback: feedback
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageDiv.textContent = '‚úì Thank you for your feedback! This helps us improve our AI.';
          messageDiv.className = 'feedback-message-success';
          messageDiv.style.display = 'block';
          
          // Hide buttons after successful feedback
          setTimeout(() => {
            document.getElementById('feedback-section').style.display = 'none';
          }, 2000);
        } else {
          throw new Error(data.error || 'Failed to submit feedback');
        }
      } catch (error) {
        console.error('Feedback error:', error);
        messageDiv.textContent = '‚úó Failed to submit feedback. Please try again.';
        messageDiv.className = 'feedback-message-error';
        messageDiv.style.display = 'block';
        
        // Re-enable buttons on error
        correctBtn.disabled = false;
        incorrectBtn.disabled = false;
      }
    }
  </script>
  
  <script>
    let embeddedMap;
    let embeddedMarkers = [];
    
    // Get habitat data for the identified species
    const speciesData = {
      species: "{{ result.species or '' }}",
      common_name: "{{ result.common_name or '' }}",
      animal_type: "{{ result.animal_type or '' }}"
    };
    
    // Initialize embedded map when page loads
    window.addEventListener('load', function() {
      initEmbeddedMap();
    });
    
    function initEmbeddedMap() {
      // Initialize the embedded map
      embeddedMap = L.map('embedded-map', {
        center: [20, 0],
        zoom: 2,
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true,
        dragging: true,
        touchZoom: true
      });
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(embeddedMap);
      
      // Fetch habitat data and add markers
      fetchHabitatData();
    }
    
    function fetchHabitatData() {
      // Use the existing habitat data function from the backend
      const url = `/api/habitat/${encodeURIComponent(speciesData.species)}?common_name=${encodeURIComponent(speciesData.common_name)}&animal_type=${encodeURIComponent(speciesData.animal_type)}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          console.log('Habitat data received:', data);
          addEmbeddedMarkers(data);
        })
        .catch(error => {
          console.error('Error fetching habitat data:', error);
          // Add some default markers for demonstration
          addDefaultMarkers();
        });
    }
    
    function addEmbeddedMarkers(habitatData) {
      if (!habitatData.habitats || habitatData.habitats.length === 0) {
        addDefaultMarkers();
        return;
      }
      
      // Clear existing markers
      embeddedMarkers.forEach(marker => {
        embeddedMap.removeLayer(marker);
      });
      embeddedMarkers = [];
      
      // Ensure coordinates are numbers
      habitatData.habitats.forEach(habitat => {
        if (typeof habitat.lat === 'string') {
          habitat.lat = parseFloat(habitat.lat);
        }
        if (typeof habitat.lng === 'string') {
          habitat.lng = parseFloat(habitat.lng);
        }
      });
      
      // Add markers
      habitatData.habitats.forEach((habitat, index) => {
        const lat = habitat.lat;
        const lng = habitat.lng;
        
        if (isNaN(lat) || isNaN(lng)) {
          console.error(`Invalid coordinates for ${habitat.name}: lat=${lat}, lng=${lng}`);
          return;
        }
        
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          console.error(`Coordinates out of range for ${habitat.name}: lat=${lat}, lng=${lng}`);
          return;
        }
        
        // Create colored marker icon
        const color = getHabitatColor(habitat.type);
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="
            background: ${color};
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            display: block;
          "></div>`,
          iconSize: [12, 12],
          iconAnchor: [6, 6],
          popupAnchor: [0, -6]
        });
        
        const marker = L.marker([lat, lng], {
          icon: markerIcon
        }).addTo(embeddedMap);
        
        marker.bindPopup(`
          <div style="font-family: Arial, sans-serif; padding: 6px;">
            <h4 style="margin: 0 0 4px 0; color: #333; font-size: 14px;">${habitat.name}</h4>
            <p style="margin: 2px 0; font-size: 11px;"><strong>Type:</strong> ${habitat.type}</p>
          </div>
        `);
        
        embeddedMarkers.push(marker);
      });
      
      // Fit map to show all markers
      if (embeddedMarkers.length > 0) {
        const group = new L.featureGroup(embeddedMarkers);
        embeddedMap.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    function addDefaultMarkers() {
      // Add some default markers for demonstration
      const defaultLocations = [
        { name: 'Australia', lat: -25.2744, lng: 133.7751, type: 'tropical' },
        { name: 'Hawaii', lat: 21.3099, lng: -157.8581, type: 'tropical' },
        { name: 'Florida Keys', lat: 24.5, lng: -81.5, type: 'subtropical' },
        { name: 'Caribbean Sea', lat: 15.5, lng: -80.0, type: 'tropical' }
      ];
      
      defaultLocations.forEach(location => {
        const color = getHabitatColor(location.type);
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="
            background: ${color};
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            display: block;
          "></div>`,
          iconSize: [12, 12],
          iconAnchor: [6, 6],
          popupAnchor: [0, -6]
        });
        
        const marker = L.marker([location.lat, location.lng], {
          icon: markerIcon
        }).addTo(embeddedMap);
        
        marker.bindPopup(`
          <div style="font-family: Arial, sans-serif; padding: 6px;">
            <h4 style="margin: 0 0 4px 0; color: #333; font-size: 14px;">${location.name}</h4>
            <p style="margin: 2px 0; font-size: 11px;"><strong>Type:</strong> ${location.type}</p>
          </div>
        `);
        
        embeddedMarkers.push(marker);
      });
      
      // Fit map to show default markers
      if (embeddedMarkers.length > 0) {
        const group = new L.featureGroup(embeddedMarkers);
        embeddedMap.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    function getHabitatColor(type) {
      const colors = {
        'tropical': '#ff6b6b',
        'temperate': '#4ecdc4',
        'polar': '#45b7d1',
        'arctic': '#45b7d1',
        'subtropical': '#96ceb4',
        'savanna': '#feca57',
        'forest': '#2ecc71',
        'mountain': '#8e44ad',
        'boreal': '#27ae60',
        'mediterranean': '#f39c12',
        'arid': '#e67e22',
        'unknown': '#95a5a6'
      };
      return colors[type] || '#95a5a6';
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        if (embeddedMap) {
          embeddedMap.invalidateSize();
        }
      }, 100);
    });
  </script>
</body>
</html>