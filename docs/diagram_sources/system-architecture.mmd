flowchart LR
    classDef client fill:#0ea5e9,stroke:#0369a1,color:#0f172a,font-weight:bold;
    classDef app fill:#6366f1,stroke:#312e81,color:#ffffff,font-weight:bold;
    classDef guard fill:#f97316,stroke:#c2410c,color:#1f2937,font-weight:bold;
    classDef service fill:#38bdf8,stroke:#1d4ed8,color:#0f172a;
    classDef data fill:#22c55e,stroke:#166534,color:#052e16;
    classDef external fill:#facc15,stroke:#a16207,color:#451a03;

    Browser[Browser\nsession + CSRF cookie]:::client --> App[Flask App\n`app.py`]:::app
    App --> Views[Templates & static assets]:::service
    Views --> Browser

    App --> Shield[Security Middleware\nCSRF + CSP + headers]:::guard
    Shield --> SecurityMgr[SecurityManager\nRate limit â€¢ CAPTCHA â€¢ trust]:::guard
    SecurityMgr --> Sessions[(Session store)]:::data

    App --> AuthSvc[AuthManager\nmagic links]:::service
    AuthSvc --> Mailer[[SMTP / Mailhog]]:::external

    App --> IdentifySvc[Identify Service\nTogether.ai orchestration]:::service
    IdentifySvc --> TempFiles(((Temp image storage))):::data
    IdentifySvc --> Together[[Together.ai Vision API]]:::external
    IdentifySvc --> MapTiles[[OpenStreetMap tiles]]:::external

    App --> HistorySvc[History Service\npersisted results]:::service
    App --> FeedbackSvc[Feedback API]:::service
    HistorySvc --> Database[(SQL database)]:::data
    FeedbackSvc --> Database

