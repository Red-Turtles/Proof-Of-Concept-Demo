sequenceDiagram
    participant User
    participant Browser
    participant Flask as Flask `/identify`
    participant Guard as Security Manager
    participant Captcha as CAPTCHA
    participant Together as Together.ai
    participant DB as Database

    User->>Browser: Select image & click Identify
    Browser->>Flask: POST /identify (file + CSRF token)
    Flask->>Guard: check_session()

    alt trust needed
        Guard-->>Flask: captcha_required
        Flask-->>Browser: 429 + challenge info
        Browser->>Flask: POST /api/security/verify
        Flask->>Guard: verify_captcha()
        Guard-->>Flask: trusted_session
    end

    Guard-->>Flask: allowed
    Flask->>Flask: validate & store temp image
    Flask->>Together: request species analysis
    Together-->>Flask: JSON result
    Flask->>DB: Save result + feedback state
    Flask-->>Browser: Render results page
    Browser-->>User: Show identification + security status
